# **HealthyBois: Heart Rate Sensor** 

The purpose of this project is to build a heart rate sensor embedded system that connects to, and communicates with, a computer via I2C communication. The user first places their finger on the sensor. The sensor then sends the heart rate sample to the STM Discovery board via I2C communication. The computer then reads the heart rate data and, through the use of a timer, displays it on a terminal every two seconds using a UART cable and driver code. The computer also sends a signal to an LED on the STM Discovery board to blink at the same rate as the current measured heart rate and outputs a DAC waveform to give a visual representation of the heart rate. For the readings we have capped the read heart rate at 150 since it is meant to be used to track resting heart rate and not active heart rate since it is not a wearable and isn't resistant to sweat. Any reading above this will cause the System to assume that no finger has been placed on the sensor.

### **Heart Rate Sensor Embedded System**
The heart rate sensor itself is a MAX30101 chip. The chip is designed for use as a high-sensitivity pulse oximeter and heart rate sensor and the datasheet can be found [here](https://www.mouser.com/datasheet/2/256/MAX30101-953565.pdf). We designed a PCB around this chip that is fairly simple, as can be seen below. The SCL, SDA, and INT lines of the chip are connected to 1k pull-up resistors because pull up resistors are required for I2C communication and to trigger the falling edge interrupt correctly. The system requires 5V, 3.3V, 1.8V to operate correctly. All of these sources are also connecters to capacitors in order to reduce noise and the effect of slight voltage fluctuations by the supply. 

![HeartRateSensorSchematic](https://user-images.githubusercontent.com/42393799/116840731-3c4b2800-ab94-11eb-90b4-3cf1dd2ed1d2.png) 
<img src="https://user-images.githubusercontent.com/42393799/116913297-87058800-ac06-11eb-82c9-e1df888534c6.png" alt="Heart Rate Sensor Board" width="500" height="315">

### **Wiring Instructions and Diagram**
Overall, the system consists of 5 main components. An external 1.8V voltage supply, our custom heart rate embedded system board, an STM 32 discovery board, a destination computer, and an oscilliscope. All of these separate components work together to create our functioning heart rate monitor. The external voltage supply along with the STM board supply voltage to power the embedded system board. Then, the embedded system board (through the MAX30101) chip on the board takes heart rate readings and sends these readings to the STM board. It does this by using an interrupt to let the STM 32 know when a reading is ready and then by sending the heart rate sample using I2C communication to the board in a communication initiated by the STM board. The STM board then stores this sample and will transmit The sample out to be shown on a host computer using PUTTY using USART and this sending of a sample occurs once every 2 seconds. In addition to this based on the heart rate ready the STM board will update a DAC sample based on the heart rate reading which makes 150 be the maximum DAC value and 0 be the minimum. The block diagram given shows the system setup that has been described. Then the indivual wiring connection are shown in the diagram below the block diagram. These individual conections set up all functionality for the system and once connected as long as the code is on the board you can press reset and the system will run correctly.

### **Driver Code**
The code for this project is split into multiple functions. There are functions to initialize the clocks for each of the peripherals, the LEDs used on the STM Discovery board, the UART peripheral, the I2C communication with the sensor, and the heart rate chip. There are also functions to set up the interrupt that is triggered when the heart rate sensor reads a heart rate sample, to set up the timers used to send the signal to the LED on the STM Discovery and to send the heart rate to the terminal, and interrupt handlers for the timers and the interrupt generated by the heart rate sensor. There are also various helper functions used in the I2C communication. The code is completely interrupt driven meaning after initialization it operates on 3 separate interrupts the first interrupt is the one generated by the heart rate chip through the I2C line which lets you know it is time to read a new sample and so it reads a new sample and updates the DAC output based on the read sample. The second interrupt is a timer that goes off every 2 seconds which will send the current heart rate sample to the host computer through USART. Then, the final interrupt is a constantly updated timer which dynamically changes so that it has the same frequency as the current heart rate sample which blinks an LED at the same rate as your heart beating. When these interupts are triggered they all perform their desired  functioinality and when no interupts are triggerred the board is in a "sleep" state not performing any computations.
